# üîÑ Notes de Migration - Gestion du PIN

## ‚ö†Ô∏è Changements Breaking

### 1. Fonctions asynchrones

Les fonctions `hashPin` et `verifyPin` sont maintenant **asynchrones** car elles utilisent l'API Web Crypto :

#### Avant :
```typescript
const hashed = hashPin('123456');
const isValid = verifyPin('123456', hashed);
```

#### Apr√®s :
```typescript
const hashed = await hashPin('123456');
const isValid = await verifyPin('123456', hashed);
```

### 2. Utilisation dans les composants

Si vous utilisez ces fonctions dans vos composants, vous devez les appeler dans une fonction async :

```typescript
const handleSavePin = async (pin: string) => {
  const hashedPin = await hashPin(pin);
  // Sauvegarder hashedPin
};
```

## ‚úÖ Pas de changement n√©cessaire

Les √©l√©ments suivants fonctionnent **sans modification** :

- ‚úÖ `PinValidator` component
- ‚úÖ `usePin` hook
- ‚úÖ `validatePinFormat()`
- ‚úÖ `isWeakPin()`
- ‚úÖ `generateSecurePin()`
- ‚úÖ `maskPin()`
- ‚úÖ `isUserLockedOut()`
- ‚úÖ `getLockoutTimeRemaining()`
- ‚úÖ `recordPinAttempt()`
- ‚úÖ `resetPinAttempts()`
- ‚úÖ `formatLockoutTime()`

## üîß Pourquoi ce changement ?

### Probl√®me
Le module `crypto` de Node.js n'est pas disponible dans le navigateur, causant l'erreur :
```
Module "crypto" has been externalized for browser compatibility
```

### Solution
Utilisation de l'**API Web Crypto** qui est :
- ‚úÖ Native dans tous les navigateurs modernes
- ‚úÖ Plus s√©curis√©e (vraie al√©atoire cryptographique)
- ‚úÖ Asynchrone par nature
- ‚úÖ Standard web

## üìä Comparaison

| Fonctionnalit√© | Avant (Node.js) | Apr√®s (Web Crypto) |
|----------------|-----------------|---------------------|
| Hash | `createHash('sha256')` | `crypto.subtle.digest('SHA-256')` |
| Random | `Math.random()` | `crypto.getRandomValues()` |
| Async | ‚ùå Synchrone | ‚úÖ Asynchrone |
| Navigateur | ‚ùå Non compatible | ‚úÖ Compatible |
| S√©curit√© | ‚ö†Ô∏è Pseudo-al√©atoire | ‚úÖ Cryptographique |

## üöÄ Exemples de migration

### Exemple 1 : Sauvegarder un PIN

```typescript
// ‚ùå Avant
const savePin = (userId: string, pin: string) => {
  const hashed = hashPin(pin);
  dispatch({ type: 'SAVE_PIN', payload: { userId, pin: hashed } });
};

// ‚úÖ Apr√®s
const savePin = async (userId: string, pin: string) => {
  const hashed = await hashPin(pin);
  dispatch({ type: 'SAVE_PIN', payload: { userId, pin: hashed } });
};
```

### Exemple 2 : V√©rifier un PIN

```typescript
// ‚ùå Avant
const checkPin = (pin: string, hashedPin: string) => {
  return verifyPin(pin, hashedPin);
};

// ‚úÖ Apr√®s
const checkPin = async (pin: string, hashedPin: string) => {
  return await verifyPin(pin, hashedPin);
};
```

### Exemple 3 : Dans un useEffect

```typescript
// ‚úÖ Correct
useEffect(() => {
  const initPin = async () => {
    const newPin = generateSecurePin();
    const hashed = await hashPin(newPin);
    setHashedPin(hashed);
  };
  
  initPin();
}, []);
```

## üìù Checklist de migration

- [ ] Identifier tous les appels √† `hashPin()`
- [ ] Identifier tous les appels √† `verifyPin()`
- [ ] Ajouter `async` aux fonctions appelantes
- [ ] Ajouter `await` devant les appels
- [ ] Tester le flux complet de validation PIN
- [ ] V√©rifier que le verrouillage fonctionne
- [ ] Tester la g√©n√©ration de PIN s√©curis√©

## üîç O√π chercher

Fichiers susceptibles d'√™tre affect√©s :
- `components/Modals.tsx` (PinManagementModal)
- `contexts/AppContext.tsx` (SAVE_PIN action)
- `components/UserDetails.tsx`
- `components/Profile.tsx`
- Tout composant personnalis√© utilisant le PIN

## üí° Bonnes pratiques

### 1. Toujours hasher en production
```typescript
// ‚ùå Ne jamais stocker en clair
user.pin = '123456';

// ‚úÖ Toujours hasher
user.hashedPin = await hashPin('123456');
```

### 2. G√©rer les erreurs
```typescript
try {
  const hashed = await hashPin(pin);
  // Sauvegarder
} catch (error) {
  console.error('Erreur de hashing:', error);
  showToast('Erreur lors de la sauvegarde du PIN', 'error');
}
```

### 3. Validation avant hashing
```typescript
const validation = validatePinFormat(pin);
if (!validation.valid) {
  showToast(validation.error, 'error');
  return;
}

const hashed = await hashPin(pin);
```

## üÜò Support

Si vous rencontrez des probl√®mes :

1. **V√©rifier la console** : Erreurs async/await ?
2. **V√©rifier les imports** : `import { hashPin } from '../utils/pinUtils'`
3. **V√©rifier le contexte** : Fonction async ?
4. **Consulter la doc** : `docs/PIN_MANAGEMENT.md`

## ‚ú® Avantages de la nouvelle impl√©mentation

1. **Compatibilit√© navigateur** : Fonctionne partout
2. **S√©curit√© renforc√©e** : Vraie al√©atoire cryptographique
3. **Standard web** : API native, pas de d√©pendance
4. **Performance** : Optimis√© pour le navigateur
5. **Future-proof** : Suit les standards web modernes

---

**Date de migration** : 30 octobre 2025  
**Version** : 1.0.0 ‚Üí 1.1.0

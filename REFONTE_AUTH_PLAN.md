# üîê Plan de refonte - Syst√®me d'authentification

## üìã Analyse de l'existant

### Actuellement
- **Login:** Utilise le PIN (6 chiffres) comme mot de passe
- **Validation:** PIN pour valider les actions
- **Profil:** Bouton "Mot de passe" qui configure un PIN
- **Biom√©trie:** Empreinte digitale disponible mais pas int√©gr√©e

### Code actuel
```typescript
// Login.tsx ligne 53
if (user && user.pin === password) {
  // Login avec PIN au lieu de password
}

// User type
interface User {
  pin?: string;  // PIN 6 chiffres
  // Pas de champ password
}
```

---

## üéØ Architecture cible

### 3 niveaux d'authentification

#### 1. **Mot de passe** (Password)
- **Usage:** Authentification initiale (login)
- **Format:** 8+ caract√®res, lettres + chiffres + symboles
- **Stockage:** Hash√© avec bcrypt (backend)
- **UI:** √âcran de login avec champ password classique

#### 2. **PIN** (6 chiffres)
- **Usage:** Validation rapide des actions dans l'app
- **Format:** 6 chiffres uniquement
- **Stockage:** Hash√© localement
- **UI:** Clavier num√©rique 6 cases
- **Actions valid√©es:**
  - Attribuer √©quipement
  - Retourner √©quipement
  - Approuver demande
  - Modifier donn√©es sensibles

#### 3. **Empreinte digitale** (Biom√©trie)
- **Usage:** Alternative au PIN pour validation
- **API:** Web Authentication API (WebAuthn)
- **Fallback:** PIN si biom√©trie non disponible
- **UI:** Ic√¥ne empreinte + animation

---

## üìä Mod√®le de donn√©es

### User (mis √† jour)

```typescript
interface User {
  id: string;
  name: string;
  email: string;
  
  // NOUVEAU: Authentification
  password: string;  // Hash bcrypt (backend)
  
  // Validation rapide
  pin?: string;      // Hash bcrypt (6 chiffres)
  
  // Biom√©trie
  fingerprintEnabled: boolean;
  fingerprintCredentialId?: string;  // WebAuthn credential
  
  // Existant
  role: string;
  department: string;
  avatarUrl: string;
  status: string;
}
```

---

## üîÑ Flux d'authentification

### 1. Login (premi√®re connexion)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ √âcran Login ‚îÇ
‚îÇ             ‚îÇ
‚îÇ Email       ‚îÇ
‚îÇ Password    ‚îÇ ‚Üê Mot de passe (8+ chars)
‚îÇ             ‚îÇ
‚îÇ [Connexion] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
   Validation
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Configuration    ‚îÇ
‚îÇ initiale         ‚îÇ
‚îÇ                  ‚îÇ
‚îÇ Cr√©er PIN (opt.) ‚îÇ ‚Üê 6 chiffres
‚îÇ Activer bio(opt.)‚îÇ ‚Üê Empreinte
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
   Dashboard
```

### 2. Validation d'action

```
Action sensible (ex: Attribuer √©quipement)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Validation       ‚îÇ
‚îÇ requise          ‚îÇ
‚îÇ                  ‚îÇ
‚îÇ [PIN]  [üëÜ Bio] ‚îÇ ‚Üê Choix utilisateur
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
   Si PIN:
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ 6 chiffres ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
   Si Biom√©trie:
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Scanner    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
   Action valid√©e
```

---

## üõ†Ô∏è Impl√©mentation

### Phase 1: Mod√®le de donn√©es ‚úÖ

**Fichiers √† modifier:**
- `types.ts` - Ajouter `password`, `fingerprintEnabled`, `fingerprintCredentialId`
- `data.ts` - Migrer users avec password par d√©faut
- `server/schemas/validation.ts` - Sch√©mas password + PIN

### Phase 2: Backend API ‚úÖ

**Fichiers √† modifier:**
- `server/routes/auth.ts` - Login avec password (pas PIN)
- `server/routes/users.ts` - Endpoints PIN + biom√©trie
- `server/auth/password.ts` - Validation password forte

**Nouveaux endpoints:**
```
POST /api/auth/login          - Email + Password
POST /api/auth/setup-pin      - Configurer PIN
POST /api/auth/validate-pin   - Valider PIN
POST /api/auth/setup-webauthn - Enregistrer biom√©trie
POST /api/auth/validate-webauthn - Valider biom√©trie
```

### Phase 3: Frontend - Login

**Fichiers √† modifier:**
- `components/Login.tsx` - Password au lieu de PIN
- `components/LoginForm.tsx` - Idem pour nouveau composant

**Changements:**
```typescript
// AVANT
if (user && user.pin === password) { ... }

// APR√àS
// Appel API backend
const response = await api.login(email, password);
```

### Phase 4: Frontend - Validation

**Fichiers √† modifier:**
- `components/PinValidator.tsx` - Garder tel quel (d√©j√† bon)
- `components/FingerprintValidator.tsx` - Int√©grer WebAuthn

**Nouveau composant:**
```typescript
// components/ActionValidator.tsx
// Combine PIN + Biom√©trie avec choix utilisateur
```

### Phase 5: Frontend - Profil

**Fichiers √† modifier:**
- `components/Profile.tsx` - S√©parer Password / PIN / Bio
- `components/UserDetails.tsx` - Idem pour admin
- `components/Modals.tsx` - Modals s√©par√©s

**UI Profil:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ S√©curit√©                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîë Mot de passe             ‚îÇ
‚îÇ    Derni√®re modif: 15/01    ‚îÇ
‚îÇ    [Modifier]               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üî¢ Code PIN                 ‚îÇ
‚îÇ    Un code PIN est d√©fini   ‚îÇ
‚îÇ    [Modifier]               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üëÜ Empreinte digitale       ‚îÇ
‚îÇ    Activ√©e                  ‚îÇ
‚îÇ    [G√©rer]                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîí S√©curit√©

### Password
- ‚úÖ Min 8 caract√®res
- ‚úÖ Lettres + chiffres requis
- ‚úÖ Hash bcrypt (12 rounds)
- ‚úÖ Stock√© backend uniquement
- ‚úÖ Validation Zod

### PIN
- ‚úÖ 6 chiffres uniquement
- ‚úÖ Pas de s√©quences (123456, 111111)
- ‚úÖ Hash bcrypt local
- ‚úÖ Rate limiting (5 tentatives)
- ‚úÖ Timeout apr√®s √©checs

### Biom√©trie
- ‚úÖ WebAuthn API standard
- ‚úÖ Credential stock√© c√¥t√© navigateur
- ‚úÖ Challenge backend
- ‚úÖ Fallback PIN si √©chec

---

## üì± UX

### Onboarding
1. **Premier login:** Password obligatoire
2. **Setup optionnel:** "Voulez-vous configurer un PIN pour validation rapide ?"
3. **Biom√©trie:** "Activer l'empreinte digitale ?" (si support√©)

### Validation d'action
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Valider l'action         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                          ‚îÇ
‚îÇ   [üî¢ Code PIN]          ‚îÇ ‚Üê Par d√©faut
‚îÇ                          ‚îÇ
‚îÇ   [üëÜ Empreinte]         ‚îÇ ‚Üê Si activ√©
‚îÇ                          ‚îÇ
‚îÇ   Annuler                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Gestion dans profil
- **Password:** Modal avec ancien + nouveau + confirmation
- **PIN:** Modal avec 6 chiffres + confirmation
- **Bio:** Enregistrement WebAuthn + test

---

## üß™ Tests

### Sc√©narios
1. ‚úÖ Login avec password
2. ‚úÖ Login avec mauvais password
3. ‚úÖ Configurer PIN
4. ‚úÖ Valider action avec PIN
5. ‚úÖ Valider action avec bio
6. ‚úÖ Fallback bio ‚Üí PIN
7. ‚úÖ Modifier password
8. ‚úÖ Modifier PIN
9. ‚úÖ D√©sactiver biom√©trie

---

## üì¶ Migration

### Donn√©es existantes

```typescript
// Migration users
users.forEach(user => {
  // PIN existant devient le password temporaire
  user.password = hashPassword(user.pin || '111111');
  
  // PIN reste pour validation
  user.pin = user.pin || null;
  
  // Biom√©trie d√©sactiv√©e par d√©faut
  user.fingerprintEnabled = false;
});
```

### Message utilisateurs
```
‚ö†Ô∏è Mise √† jour de s√©curit√©

Votre code PIN est maintenant utilis√© uniquement
pour valider les actions rapides.

Veuillez configurer un mot de passe s√©curis√©
pour vous connecter.

Mot de passe temporaire: [votre ancien PIN]
```

---

## ‚è±Ô∏è Estimation

- **Phase 1:** Mod√®le donn√©es - 30min
- **Phase 2:** Backend API - 2h
- **Phase 3:** Login frontend - 1h
- **Phase 4:** Validation frontend - 2h
- **Phase 5:** Profil UI - 1.5h
- **Tests:** 1h

**Total:** ~8h

---

## üéØ Priorit√©s

### Must-have (MVP)
1. ‚úÖ Password pour login
2. ‚úÖ PIN pour validation
3. ‚úÖ S√©paration UI profil

### Nice-to-have
1. ‚è≥ Biom√©trie WebAuthn
2. ‚è≥ Remember device
3. ‚è≥ 2FA optionnel

---

## üöÄ Prochaine √©tape

**Commencer par Phase 1:**
1. Modifier `types.ts` - Ajouter champs User
2. Migrer `data.ts` - Ajouter passwords
3. Tester compilation

**Voulez-vous que je commence l'impl√©mentation ?**

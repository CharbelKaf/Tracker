/**
 * Script pour g√©n√©rer les ic√¥nes PWA √† partir d'une image source
 * Utilisation: node scripts/generate-icons.js <source-image>
 * 
 * Pr√©requis: npm install sharp --save-dev
 */

import sharp from 'sharp';
import { mkdir, access } from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Tailles d'ic√¥nes √† g√©n√©rer
const ICON_SIZES = [72, 96, 128, 144, 152, 192, 384, 512];
const SHORTCUT_SIZE = 96;

// Couleurs
const PRIMARY_COLOR = '#6366f1';
const BACKGROUND_COLOR = '#ffffff';

/**
 * Cr√©e le dossier s'il n'existe pas
 */
async function ensureDir(dir) {
  try {
    await access(dir);
  } catch {
    await mkdir(dir, { recursive: true });
    console.log(`‚úÖ Dossier cr√©√©: ${dir}`);
  }
}

/**
 * G√©n√®re une ic√¥ne simple avec texte
 */
async function generateSimpleIcon(size, outputPath) {
  const svg = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:${PRIMARY_COLOR};stop-opacity:1" />
          <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="${size}" height="${size}" rx="${size * 0.2}" fill="url(#grad)"/>
      <text 
        x="50%" 
        y="50%" 
        dominant-baseline="middle" 
        text-anchor="middle" 
        font-family="Arial, sans-serif" 
        font-weight="bold" 
        font-size="${size * 0.5}" 
        fill="${BACKGROUND_COLOR}">N</text>
    </svg>
  `;

  await sharp(Buffer.from(svg))
    .resize(size, size)
    .png()
    .toFile(outputPath);
  
  console.log(`‚úÖ G√©n√©r√©: ${outputPath} (${size}x${size})`);
}

/**
 * G√©n√®re une ic√¥ne de raccourci
 */
async function generateShortcutIcon(name, emoji, outputPath) {
  const size = SHORTCUT_SIZE;
  const svg = `
    <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
      <rect width="${size}" height="${size}" rx="${size * 0.2}" fill="${PRIMARY_COLOR}"/>
      <text 
        x="50%" 
        y="50%" 
        dominant-baseline="middle" 
        text-anchor="middle" 
        font-size="${size * 0.6}">${emoji}</text>
    </svg>
  `;

  await sharp(Buffer.from(svg))
    .resize(size, size)
    .png()
    .toFile(outputPath);
  
  console.log(`‚úÖ G√©n√©r√©: ${outputPath} (shortcut)`);
}

/**
 * G√©n√®re toutes les ic√¥nes
 */
async function generateAllIcons(sourceImage = null) {
  const publicDir = join(__dirname, '..', 'public');
  const iconsDir = join(publicDir, 'icons');
  
  await ensureDir(iconsDir);

  console.log('\nüé® G√©n√©ration des ic√¥nes PWA...\n');

  if (sourceImage) {
    // Utiliser l'image source fournie
    console.log(`üì∏ Source: ${sourceImage}\n`);
    
    for (const size of ICON_SIZES) {
      const outputPath = join(iconsDir, `icon-${size}x${size}.png`);
      
      await sharp(sourceImage)
        .resize(size, size, {
          fit: 'cover',
          position: 'center'
        })
        .png()
        .toFile(outputPath);
      
      console.log(`‚úÖ G√©n√©r√©: icon-${size}x${size}.png`);
    }
  } else {
    // G√©n√©rer des ic√¥nes simples par d√©faut
    console.log('üì∏ Aucune source fournie, g√©n√©ration d\'ic√¥nes par d√©faut\n');
    
    for (const size of ICON_SIZES) {
      const outputPath = join(iconsDir, `icon-${size}x${size}.png`);
      await generateSimpleIcon(size, outputPath);
    }
  }

  // G√©n√©rer les ic√¥nes de raccourcis
  console.log('\nüîó G√©n√©ration des ic√¥nes de raccourcis...\n');
  
  await generateShortcutIcon(
    'inventory',
    'üì¶',
    join(iconsDir, 'shortcut-inventory.png')
  );
  
  await generateShortcutIcon(
    'assign',
    'üë§',
    join(iconsDir, 'shortcut-assign.png')
  );

  console.log('\n‚úÖ Toutes les ic√¥nes ont √©t√© g√©n√©r√©es avec succ√®s!\n');
  console.log('üìÅ Emplacement: public/icons/\n');
}

/**
 * G√©n√®re un favicon.ico
 */
async function generateFavicon() {
  const publicDir = join(__dirname, '..', 'public');
  const iconsDir = join(publicDir, 'icons');
  const faviconPath = join(publicDir, 'favicon.ico');
  
  const iconPath = join(iconsDir, 'icon-192x192.png');
  
  try {
    await sharp(iconPath)
      .resize(32, 32)
      .toFile(faviconPath);
    
    console.log('‚úÖ Favicon g√©n√©r√©: public/favicon.ico\n');
  } catch (error) {
    console.warn('‚ö†Ô∏è  Impossible de g√©n√©rer favicon.ico:', error.message);
  }
}

// Point d'entr√©e
const sourceImage = process.argv[2];

generateAllIcons(sourceImage)
  .then(() => generateFavicon())
  .then(() => {
    console.log('üéâ G√©n√©ration termin√©e!\n');
    console.log('üìã Prochaines √©tapes:');
    console.log('   1. V√©rifier les ic√¥nes dans public/icons/');
    console.log('   2. Tester l\'installation PWA');
    console.log('   3. Lancer un audit Lighthouse\n');
  })
  .catch((error) => {
    console.error('‚ùå Erreur:', error);
    process.exit(1);
  });
